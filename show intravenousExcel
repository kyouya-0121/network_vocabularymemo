Sub ImportAndFormatCSV_Full()
    Dim fDialog As FileDialog
    Dim csvFolder As String
    Dim csvFile As String
    Dim wsA As Worksheet, wsB As Worksheet
    Dim csvWB As Workbook
    Dim csvWS As Worksheet
    Dim lastRow As Long, i As Long
    Dim pasteRow As Long, pasteCol As Long
    Dim cellValue As String
    
    ' --- 対象シート ---
    Set wsA = ThisWorkbook.Sheets("A") ' 12ポート
    Set wsB = ThisWorkbook.Sheets("B") ' 24ポート
    
    ' --- フォルダ選択ダイアログ ---
    Set fDialog = Application.FileDialog(msoFileDialogFolderPicker)
    fDialog.Title = "CSVフォルダを選択してください"
    If fDialog.Show <> -1 Then Exit Sub
    csvFolder = fDialog.SelectedItems(1) & "\"
    
    ' --- CSV ファイルループ ---
    csvFile = Dir(csvFolder & "*.csv")
    Do While csvFile <> ""
        ' CSVを開く
        Set csvWB = Workbooks.Open(csvFolder & csvFile)
        Set csvWS = csvWB.Sheets(1)
        
        ' ポート数判定（ヘッダ1行 + データ行）
        lastRow = csvWS.Cells(csvWS.Rows.Count, 1).End(xlUp).Row
        Dim targetWS As Worksheet
        If lastRow - 1 = 12 Then
            Set targetWS = wsA
        ElseIf lastRow - 1 = 24 Then
            Set targetWS = wsB
        Else
            ' それ以外はスキップ
            csvWB.Close False
            csvFile = Dir()
            GoTo NextCSV
        End If
        
        ' --- 貼り付け開始行を自動判定 ---
        pasteRow = 11
        Do While targetWS.Cells(pasteRow, 6).Value <> ""
            pasteRow = pasteRow + 1
        Loop
        
        ' F列にホスト名（先頭16文字）
        targetWS.Cells(pasteRow, 6).Value = Left(csvFile, 16)
        
        ' G列から横貼り
        pasteCol = 7
        For i = 2 To lastRow
            cellValue = csvWS.Cells(i, 2).Value
            If Trim(cellValue) = "" Then cellValue = "空"
            targetWS.Cells(pasteRow, pasteCol).Value = cellValue
            pasteCol = pasteCol + 1
        Next i
        
        ' --- 条件付き色付け・文字置換 ---
        For i = 7 To pasteCol - 1
            cellValue = targetWS.Cells(pasteRow, i).Value
            Select Case True
                Case cellValue = "空"
                    targetWS.Cells(pasteRow, i).Value = "⚫"
                    targetWS.Cells(pasteRow, i).Font.Color = RGB(255, 165, 0) ' オレンジ
                Case InStr(cellValue, "ATATA") > 0
                    targetWS.Cells(pasteRow, i).Value = "⚫"
                    targetWS.Cells(pasteRow, i).Font.Color = RGB(0, 0, 0) ' 黒
                Case InStr(cellValue, "SW") > 0
                    targetWS.Cells(pasteRow, i).Value = "⚫"
                    targetWS.Cells(pasteRow, i).Font.Color = RGB(0, 128, 0) ' 緑
                Case InStr(cellValue, "Printer") > 0
                    targetWS.Cells(pasteRow, i).Value = "⚫"
                    targetWS.Cells(pasteRow, i).Font.Color = RGB(0, 0, 255) ' 青
                Case Else
                    targetWS.Cells(pasteRow, i).Value = "⚫"
                    targetWS.Cells(pasteRow, i).Font.Color = RGB(255, 165, 0) ' オレンジ
            End Select
        Next i
        
        csvWB.Close False
NextCSV:
        csvFile = Dir()
    Loop
    
    MsgBox "CSVの取り込みとフォーマットが完了しました。", vbInformation
End Sub
$csvFolder = Read-Host "CSVフォルダのフルパスを入力してください"
if (!(Test-Path $csvFolder)) { Write-Host "フォルダが存在しません"; exit }

$excel = New-Object -ComObject Excel.Application
$excel.Visible = $true
$wb = $excel.Workbooks.Open("C:\path\template.xlsx")
$wsA = $wb.Sheets.Item("A")
$wsB = $wb.Sheets.Item("B")

# CSVファイルループ
$csvFiles = Get-ChildItem $csvFolder -Filter "*.csv"
foreach ($file in $csvFiles) {

    $csvWB = $excel.Workbooks.Open($file.FullName)
    $csvWS = $csvWB.Sheets.Item(1)
    $lastRow = $csvWS.Cells($csvWS.Rows.Count,1).End(-4162).Row  # xlUp=-4162

    # シート振り分け
    if ($lastRow - 1 -eq 12) { $targetWS = $wsA }
    elseif ($lastRow - 1 -eq 24) { $targetWS = $wsB }
    else { $csvWB.Close($false); continue }

    # 横貼り開始列
    $pasteRow = 11
    $pasteCol = $targetWS.Cells($pasteRow, $targetWS.Columns.Count).End(-4159).Column + 1  # xlToLeft=-4159
    if ($pasteCol -lt 7) { $pasteCol = 7 }

    # F列にホスト名
    $targetWS.Cells.Item($pasteRow, $pasteCol - 1).Value = $file.BaseName.Substring(0,16)

    # CSVの2列目を横に貼り付け
    for ($i=2; $i -le $lastRow; $i++) {
        $cellValue = $csvWS.Cells.Item($i,2).Value
        if ([string]::IsNullOrWhiteSpace($cellValue)) { $cellValue = "空" }
        $targetWS.Cells.Item($pasteRow, $pasteCol).Value = $cellValue
        $pasteCol++
    }

    # 条件付き色付け（空 > ATATA+SW > ATATA > SW > Printer > その他）
    $startCol = $targetWS.Cells($pasteRow,6).End(-4159).Column - ($lastRow-2) + 1
    $endCol = $targetWS.Cells($pasteRow,6).End(-4159).Column
    for ($i = $startCol; $i -le $endCol; $i++) {
        $cellValue = $targetWS.Cells.Item($pasteRow, $i).Value

        if ($cellValue -eq "空") {
            $targetWS.Cells.Item($pasteRow,$i).Value = "⚫"
            $targetWS.Cells.Item($pasteRow,$i).Font.Color = 0x00A5FF # オレンジ
        }
        elseif ($cellValue -match "ATATA.*SW|SW.*ATATA") {
            $targetWS.Cells.Item($pasteRow,$i).Value = "⚫"
            $targetWS.Cells.Item($pasteRow,$i).Font.Color = 0x008000 # 緑
        }
        elseif ($cellValue -match "ATATA") {
            $targetWS.Cells.Item($pasteRow,$i).Value = "⚫"
            $targetWS.Cells.Item($pasteRow,$i).Font.Color = 0x000000 # 黒
        }
        elseif ($cellValue -match "SW") {
            $targetWS.Cells.Item($pasteRow,$i).Value = "⚫"
            $targetWS.Cells.Item($pasteRow,$i).Font.Color = 0x008000 # 緑
        }
        elseif ($cellValue -match "Printer") {
            $targetWS.Cells.Item($pasteRow,$i).Value = "⚫"
            $targetWS.Cells.Item($pasteRow,$i).Font.Color = 0x0000FF # 青
        }
        else {
            $targetWS.Cells.Item($pasteRow,$i).Value = "⚫"
            $targetWS.Cells.Item($pasteRow,$i).Font.Color = 0x00A5FF # オレンジ
        }
    }

    $csvWB.Close($false)
}

$wb.SaveAs("C:\path\output.xlsx")
$wb.Close()
$excel.Quit()
Write-Host "CSV横貼りと色付け完了"




